# MAC消息验证码

Hash算法能够完成密码学目标之一的完整性校验，但却不能避免消息被篡改。为避免消息被篡改，需要用到消息验证码。消息验证码非常重要，一般结合加密算法一起使用

## 1 什么是消息验证码

消息验证码算法的特点：
1. 证明消息没有被篡改，这和Hash算法类似
2. 消息是正确的发送者发送的，也就是说消息是经过验证的

如何确保消息是特定人发送的呢？在通信双方可以维护同一个密钥，只有拥有密钥的通信双方才能生成和验证消息验证码，消息验证码算法需要一个密钥，这和对称加密算法是一样的，通信双方在消息传递之前需要获得同样的密钥

消息验证码的模型很简单：

:::note 公式
MAC值 = mac(消息, 密钥)
:::

MAC值一般和原始消息一起传输，原始消息可以选择加密，也可以选择不加密，通信双方会以相同的方式生成MAC值，然后进行比较，下图概括了该过程：

![MAC处理流程](./assets/MAC处理流程.svg)

一旦两个MAC值相同表示MAC验证正确，否则验证失败

## 2 MAC算法的种类

在密码学中，MAC算法有两种形式，分别是CBC-MAC算法和HMAC算法

CBC-MAC算法从块密码算法的[[分组密码的模式|CBC分组模式]]演变而来，简单地说就是最后一个密文分组的值就是MAC值，在HTTP中应用最多的MAC算法是HMAC算法，所以重点讲解HMAC算法

HMAC（Hash-based Message AuthenticationCode）算法使用Hash算法作为加密基元，HMAC结合Hash算法有多种变种，比如HMAC-SHA-1、HMAC-SHA256、HMAC-SHA512

HMAC算法公式如下所示（Ref RFC 2104）：
$$
HMAC(K, m)=H((K'\oplus opad)|| H((K' \oplus ipad) || m))
$$
其中：
* $H$为Hash函数（如[[SHA系列函数介绍|SHA系列函数]]）
* $K$为密钥（secret key）
* $m$是要认证的消息
* $K'$是从原始密钥$K$导出的另一个秘密密钥（如果$K$短于散列函数的输入块大小，则向右填充（Padding）零；如果比该块大小更长，则对$K$进行散列）
* $||$表示字符串串接（concatenate）
* $\oplus$代表以后（XOR）
* $opad$是外部填充（`0x5c5c5c...5c5c`，一段十六进制常量）
* $ipad$是外部填充（`0x363636...3636`，一段十六进制常量）




